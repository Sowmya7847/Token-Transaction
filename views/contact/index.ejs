<%- include('../partials/header', { title: title, user: user }) %>

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-0"><i class="bi bi-envelope"></i> Contact Us</h1>
                <p class="text-muted">Get in touch with us. We're here to help!</p>
            </div>
            <button class="btn btn-outline-primary btn-sm" onclick="showHelp('contact')" data-bs-toggle="tooltip" title="Get help with contact form">
                <i class="bi bi-question-circle"></i> Help
            </button>
        </div>
    </div>
</div>

<div class="guide-panel fade-in mb-4">
    <h6><i class="bi bi-info-circle"></i> How to Contact Us</h6>
    <ul>
        <li>Fill out the form below with your inquiry</li>
        <li>We'll respond to your email as soon as possible</li>
        <li>For urgent matters, please include "URGENT" in the subject</li>
        <li>All fields are required to ensure we can help you properly</li>
    </ul>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-envelope-paper"></i> Send Us a Message</h5>
            </div>
            <div class="card-body p-4">
                <form id="contactForm" action="https://formspree.io/f/xldrkklq" method="POST">
                    <input type="hidden" name="_next" id="formNext" value="">
                    <input type="hidden" name="_captcha" value="false">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="contactName" class="form-label">
                                Your Name 
                                <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" title="Enter your full name"></i>
                            </label>
                            <input type="text" class="form-control" id="contactName" name="name" placeholder="John Doe" required>
                            <div class="form-help-text">This helps us address you properly</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="contactEmail" class="form-label">
                                Your Email 
                                <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" title="Enter your email address where we can reach you"></i>
                            </label>
                            <input type="email" class="form-control" id="contactEmail" name="email" placeholder="your.email@example.com" required>
                            <div class="form-help-text">We'll use this to respond to your inquiry</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="contactSubject" class="form-label">
                            Subject 
                            <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" title="Brief description of your inquiry"></i>
                        </label>
                        <input type="text" class="form-control" id="contactSubject" name="subject" placeholder="e.g., Account Question, Technical Issue" required>
                        <div class="form-help-text">A brief summary of what you need help with</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="contactMessage" class="form-label">
                            Message 
                            <i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" title="Provide details about your inquiry"></i>
                        </label>
                        <textarea class="form-control" id="contactMessage" name="message" rows="6" placeholder="Please provide as much detail as possible so we can help you better..." maxlength="500" required></textarea>
                        <div class="form-help-text">
                            <span id="charCount">0</span> / 500 characters (minimum 10 required)
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-send"></i> Send Message
                        </button>
                    </div>
                    
                    <div class="mt-3 text-center">
                        <small class="text-muted">
                            <i class="bi bi-shield-check"></i> Your information is secure and will only be used to respond to your inquiry
                        </small>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Contact Information</h5>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <h6><i class="bi bi-envelope text-primary"></i> Email Support</h6>
                    <p class="text-muted mb-0">Send us an email and we'll get back to you as soon as possible.</p>
                </div>
                
                <div class="mb-4">
                    <h6><i class="bi bi-clock-history text-success"></i> Response Time</h6>
                    <p class="text-muted mb-0">
                        We typically respond within <strong>24-48 hours</strong> during business days.
                    </p>
                </div>
                
                <div class="mb-4">
                    <h6><i class="bi bi-exclamation-triangle text-warning"></i> Urgent Matters</h6>
                    <p class="text-muted mb-0">
                        For urgent issues, please include <strong>"URGENT"</strong> in the subject line.
                    </p>
                </div>
                
                <div>
                    <h6><i class="bi bi-shield-check text-danger"></i> Privacy</h6>
                    <p class="text-muted mb-0">
                        Your information is secure and will only be used to respond to your inquiry.
                    </p>
                </div>
            </div>
        </div>
        
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Before You Contact</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="bi bi-check-circle text-success"></i> Check our <a href="#" onclick="showHelp('dashboard'); return false;">Help section</a> for common questions
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle text-success"></i> Review your transaction history for account issues
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle text-success"></i> Include your account email in the message
                    </li>
                    <li>
                        <i class="bi bi-check-circle text-success"></i> Provide as much detail as possible
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div id="alertContainer" style="position: fixed; top: 20px; right: 20px; z-index: 10000; max-width: 400px;"></div>

<%- include('../partials/footer') %>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const contactForm = document.getElementById('contactForm');
    const formNext = document.getElementById('formNext');
    
    // Set redirect URL
    if (formNext) {
        formNext.value = window.location.origin + '/contact?success=true';
    }
    
    // Check for success parameter in URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
        if (typeof showAlert === 'function') {
            showAlert('Message sent successfully! We will get back to you soon.', 'success', 10000);
        } else {
            alert('Message sent successfully! We will get back to you soon.');
        }
        // Clean URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }
    
    // Handle form submission
    if (contactForm) {
        contactForm.addEventListener('submit', function(e) {
            // Validate form before submission
            if (!validateContactForm()) {
                e.preventDefault();
                return false;
            }
            
            // Show loading state
            const submitBtn = contactForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';
            
            // Form will submit to Formspree
            // Formspree will handle the submission and redirect
        });
    }
    
    // Validate contact form
    function validateContactForm() {
        const nameField = document.getElementById('contactName');
        const emailField = document.getElementById('contactEmail');
        const subjectField = document.getElementById('contactSubject');
        const messageField = document.getElementById('contactMessage');
        
        if (!nameField || !emailField || !subjectField || !messageField) {
            alert('Form fields not found. Please refresh the page.');
            return false;
        }
        
        const name = nameField.value.trim();
        const email = emailField.value.trim();
        const subject = subjectField.value.trim();
        const message = messageField.value.trim();
        
        if (!name) {
            if (typeof showAlert === 'function') {
                showAlert('Please enter your name', 'warning');
            } else {
                alert('Please enter your name');
            }
            document.getElementById('contactName').focus();
            return false;
        }
        
        if (!email || !email.includes('@')) {
            if (typeof showAlert === 'function') {
                showAlert('Please enter a valid email address', 'warning');
            } else {
                alert('Please enter a valid email address');
            }
            document.getElementById('contactEmail').focus();
            return false;
        }
        
        if (!subject) {
            if (typeof showAlert === 'function') {
                showAlert('Please enter a subject', 'warning');
            } else {
                alert('Please enter a subject');
            }
            document.getElementById('contactSubject').focus();
            return false;
        }
        
        if (!message || message.length < 10) {
            if (typeof showAlert === 'function') {
                showAlert('Please enter a message with at least 10 characters', 'warning');
            } else {
                alert('Please enter a message with at least 10 characters');
            }
            document.getElementById('contactMessage').focus();
            return false;
        }
        
        if (message.length > 500) {
            if (typeof showAlert === 'function') {
                showAlert('Message is too long. Please keep it under 500 characters.', 'warning');
            } else {
                alert('Message is too long. Please keep it under 500 characters.');
            }
            document.getElementById('contactMessage').focus();
            return false;
        }
        
        return true;
    }
    
    // Character counter for message
    const messageField = document.getElementById('contactMessage');
    const charCount = document.getElementById('charCount');
    if (messageField && charCount) {
        messageField.addEventListener('input', function() {
            const length = this.value.length;
            charCount.textContent = length;
            if (length > 500) {
                charCount.classList.add('text-danger');
                this.classList.add('is-invalid');
            } else {
                charCount.classList.remove('text-danger');
                this.classList.remove('is-invalid');
            }
        });
    }
    
    // Initialize tooltips after Bootstrap is loaded
    setTimeout(function() {
        if (typeof bootstrap !== 'undefined') {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
    }, 100);
});
</script>

